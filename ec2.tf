module "ec2-instance" {
  source  = "terraform-aws-modules/ec2-instance/aws"
  version = "5.0.0"

  # Required variables
  name                   = "public-ec2-${var.environment}"
  ami                    = data.aws_ami.amazon_linux.id
  instance_type          = var.ec2_instance_type
  key_name               = aws_key_pair.aws_autogenerated_key_pair.key_name
  monitoring             = true
  subnet_id              = module.vpc.public_subnets[0]
  vpc_security_group_ids = [module.public-ec2-security-group.security_group_id]
  ignore_ami_changes     = var.ignore_ami_changes
  user_data              = data.template_file.webserver_launch_configuration_user_data.rendered

  tags                   = var.tags

}

data "template_file" "webserver_launch_configuration_user_data" {
  template = file("${path.module}/template/user_data.sh")
}

resource "tls_private_key" "autogenerated_key" {
  algorithm = "RSA"
  rsa_bits  = 4096
}

resource "aws_key_pair" "aws_autogenerated_key_pair" {
  key_name   = var.aws_key_pair_name
  public_key = tls_private_key.autogenerated_key.public_key_openssh
}

resource "local_file" "local_key_pair" {
  filename        = "${path.module}/ec2_key_pair/${var.aws_key_pair_name}.pem"
  file_permission = "0400"
  content         = tls_private_key.autogenerated_key.private_key_pem
}